import telebot
from telebot import types
from flask import Flask
import threading
import os
import sqlite3
import random
import time

# ================= Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ =================

# ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© TOKEN ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Secrets ÙÙŠ Replit
TOKEN = os.environ.get("TOKEN")

if not TOKEN:
    print("Error: TOKEN not found in environment variables.")
    # ÙŠÙ…ÙƒÙ†Ùƒ ÙˆØ¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙÙ‚Ø·ØŒ Ù„ÙƒÙ† Ù„Ø§ ÙŠÙ†ØµØ­ Ø¨Ù‡ Ù„Ù„Ø£Ù…Ø§Ù†
    # TOKEN = "YOUR_TOKEN_HERE"

bot = telebot.TeleBot(TOKEN, parse_mode="HTML")
app = Flask(__name__) # ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§

# ================= Ø§Ù„Ù‚Ù†Ø§Ø© =================

CHANNEL_LINK = "https://t.me/QRAN_JANA"

# ================= Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =================

conn = sqlite3.connect('bot_data.db', check_same_thread=False)
c = conn.cursor()

c.execute('''
CREATE TABLE IF NOT EXISTS roles(
    chat_id INTEGER,
    user_id INTEGER,
    rank INTEGER,
    PRIMARY KEY(chat_id, user_id)
)
''')

c.execute('''
CREATE TABLE IF NOT EXISTS global_bans(
    user_id INTEGER PRIMARY KEY
)
''')

conn.commit()

# ================= Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¨ÙˆØª =================

@bot.message_handler(content_types=['new_chat_members'])
def bot_added(message):
    for member in message.new_chat_members:
        if member.id == bot.get_me().id:
            adder = message.from_user  
            mention = f'<a href="tg://user?id={adder.id}">{adder.first_name}</a>'  

            bot.send_message(  
                message.chat.id,  
                f"â‡œ Ù…Ù† ã€Œ {mention} ã€\n"  
                f"â‡œ Ù„Ø§Ø²Ù… ØªØ¹Ø·ÙŠÙ†ÙŠ Ø§Ø´Ø±Ø§Ù ÙˆØµÙ„Ø§Ø­ÙŠÙ‡ Ø§Ø¶Ø§ÙÙ‡ Ù…Ø´Ø±ÙÙŠÙ† Ø¹Ø´Ø§Ù† Ø§ØªÙØ¹Ù„\n"  
                f"à¼„\n\n"  
                f"ğŸ“¢ Ù‚Ù†Ø§ØªÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠØ©:\n{CHANNEL_LINK}",  
                disable_web_page_preview=True  
            )

# ================= ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø´Ø±Ù =================

@bot.my_chat_member_handler()
def admin_status_change(update):
    chat_id = update.chat.id  
    new_status = update.new_chat_member.status  
    old_status = update.old_chat_member.status  

    actor = update.from_user  
    mention = f'<a href="tg://user?id={actor.id}">{actor.first_name}</a>'  

    # ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØª Ù…Ø´Ø±Ù  
    if new_status == "administrator" and old_status != "administrator":  
        bot.send_message(  
            chat_id,  
            f"â‡œ Ù…Ù† ã€Œ {mention} ã€\n"  
            f"â‡œ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©\n"  
            f"à¼„"  
        )  

    # ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ù† Ø§Ù„Ù…Ø´Ø±Ù  
    if old_status == "administrator" and new_status == "member":  
        bot.send_message(  
            chat_id,  
            f"â‡œ Ù…Ù† ã€Œ {mention} ã€\n"  
            f"â‡œ ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©\n"  
            f"à¼„"  
        )

# ================= Ø§Ù„Ø±ØªØ¨ =================

RANKS = {"dev":5,"owner":4,"deputy":3,"admin":2,"vip":1,"member":0}

RANK_NAMES = {
    5:"ğŸ’» Ù…Ø·ÙˆØ±",
    4:"ğŸ‘‘ Ø§Ù„Ù…Ø§Ù„Ùƒ",
    3:"ğŸ›¡ï¸ Ø§Ù„Ù†Ø§Ø¦Ø¨",
    2:"âš”ï¸ Ø§Ù„Ø£Ø¯Ù…Ù†",
    1:"â­ Ø§Ù„Ù…Ù…ÙŠØ²",
    0:"ğŸ‘¤ Ø¹Ø¶Ùˆ"
}

# Ø¶Ø¹ Ø§ÙŠØ¯ÙŠ Ø­Ø³Ø§Ø¨Ùƒ Ù‡Ù†Ø§
DEVELOPER_ID = 7447335995
HELPER_ID = 5727014604

# ================= Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±ØªØ¨ =================

def get_rank(chat_id, user_id):
    if user_id == DEVELOPER_ID:
        return RANKS["dev"]
    if user_id == HELPER_ID:
        return RANKS["deputy"]

    c.execute('SELECT rank FROM roles WHERE chat_id=? AND user_id=?',(chat_id, user_id))  
    row = c.fetchone()  
    return row[0] if row else 0

def set_rank(chat_id, user_id, rank):
    c.execute('INSERT OR REPLACE INTO roles(chat_id, user_id, rank) VALUES(?,?,?)', (chat_id, user_id, rank))
    conn.commit()

# ================= Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ø¹Ø§Ù… =================

def get_global_bans():
    c.execute('SELECT user_id FROM global_bans')
    return [row[0] for row in c.fetchall()]

def add_global_ban(user_id):
    c.execute('INSERT OR IGNORE INTO global_bans(user_id) VALUES(?)', (user_id,))
    conn.commit()

# ================= Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø´Ø®Øµ =================

def extract_user(message, parts):
    # 1. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©
    if message.reply_to_message:
        return message.reply_to_message.from_user.id

    # 2. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù†Ø´Ù† (Entity)
    if message.entities:  
        for entity in message.entities:  
            if entity.type == "text_mention":  
                return entity.user.id  
    
    # 3. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§ÙŠØ¯ÙŠ Ù…Ø¨Ø§Ø´Ø±
    if len(parts) > 1 and parts[1].isdigit():  
        return int(parts[1])  
    
    # 4. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„ÙŠÙˆØ²Ø± (Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø®ØµÙˆØµÙŠØ© ØªÙ„ÙŠØ¬Ø±Ø§Ù…)
    if len(parts) > 1 and parts[1].startswith("@"):  
        try:  
            # Ù…Ù„Ø§Ø­Ø¸Ø©: get_chat Ù‚Ø¯ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ù…Ø¹ Ø§Ù„ÙŠÙˆØ²Ø±Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„Ø¨ÙˆØª Ø³Ø§Ø¨Ù‚Ø§Ù‹
            user = bot.get_chat(parts[1])  
            return user.id  
        except:  
            pass  

    return None

# ================= Ø±Ø³Ø§Ù„Ø© ØªÙØ§Ø¹Ù„ÙŠØ© =================

def send_action(chat_id, message, target_id, admin_name, action):
    try:  
        user = bot.get_chat(target_id)  
        target_name = user.first_name  
    except:  
        target_name = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"  

    mention = f'<a href="tg://user?id={target_id}">{target_name}</a>'  

    markup = types.InlineKeyboardMarkup()  
    btn = types.InlineKeyboardButton(  
        text=f"ÙØªØ­ Ø­Ø³Ø§Ø¨ {target_name}",  
        url=f"tg://user?id={target_id}"  
    )  
    markup.add(btn)  

    bot.reply_to(  
        message,  
        f"ğŸ‘®â€â™‚ï¸ Ø¨ÙˆØ§Ø³Ø·Ø©: {admin_name}\n"  
        f"ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {mention}\n"  
        f"âš–ï¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: {action}",  
        reply_markup=markup  
    )

# ================= ØªØ¹ÙŠÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠ =================

def auto_assign_ranks(chat_id):
    try:
        chat = bot.get_chat(chat_id)
        if chat.type == 'private':
            return

        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù‚Ø¯ ØªÙØ´Ù„ Ø¥Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ù„ÙŠØ³ Ù…Ø´Ø±ÙØ§Ù‹)
        try:
            admins = bot.get_chat_administrators(chat_id)
            for admin in admins:
                if admin.status == 'creator':
                    set_rank(chat_id, admin.user.id, RANKS["owner"])
                elif admin.user.id != bot.get_me().id:
                    # ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ø¯Ù…Ù†ÙŠØ©
                    current_rank = get_rank(chat_id, admin.user.id)
                    if current_rank < RANKS["admin"]:
                         set_rank(chat_id, admin.user.id, RANKS["admin"])
        except Exception as e:
            pass # Ù‚Ø¯ Ù„Ø§ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ø¨ÙˆØª ØµÙ„Ø§Ø­ÙŠØ© Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†
    except:  
        pass

# ================= Flask Keep Alive =================

@app.route('/')
def home():
    return "Bot is running!"

def run():
    app.run(host="0.0.0.0", port=8080)

def keep_alive():
    t = threading.Thread(target=run)
    t.start()

# ================= Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =================

@bot.message_handler(func=lambda m: True)
def handle(message):
    chat_id = message.chat.id  
    user_id = message.from_user.id  
    text = (message.text or "").strip()  
    parts = text.split()  
    command = parts[0] if parts else ""  

    # ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª
    if message.chat.type == 'channel':
        return

    # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨ (ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¨ÙˆØª)
    if random.randint(1, 10) == 1: # ØªØ´ØºÙŠÙ„Ù‡Ø§ Ù…Ø±Ø© ÙƒÙ„ 10 Ø±Ø³Ø§Ø¦Ù„ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¶ØºØ·
        auto_assign_ranks(chat_id)  

    rank = get_rank(chat_id, user_id)  

    # ===== Ø­Ø¸Ø± Ø¹Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ =====  
    if user_id in get_global_bans() and rank < RANKS["dev"]:  
        try:  
            bot.kick_chat_member(chat_id, user_id)  
        except:  
            pass  
        return  

    # ===== Ø°ÙƒØ± Ø§Ù„Ø¨ÙˆØª =====  
    BOT_NAMES = ["jana", "Ø¬Ù†ÙŠ", "Ø¬Ù†Ù‰", "ØªÙˆØªÙˆ"]  
    if any(name in text.lower() for name in BOT_NAMES):  
        bot.send_message(chat_id, random.choice(["Ù†ÙˆØ±Øª ğŸŒŸ", "ÙŠØ§ Ù‡Ù„Ø§ ğŸŒ¸", "Ù…Ù†ÙˆØ± ğŸ”¥", "Ø¹ÙŠÙˆÙ† Ø¬Ù†ÙŠ ğŸ‘€"]))  
        return  

    # ===== Ø±ØªØ¨ØªÙŠ =====  
    if text == "Ø±ØªØ¨ØªÙŠ":  
        bot.reply_to(message,  
        f"ğŸ‘¤ {message.from_user.first_name}\n"  
        f"ğŸ†” <code>{user_id}</code>\n"  
        f"ğŸ… {RANK_NAMES.get(rank, 'Ø¹Ø¶Ùˆ')}")  
        return  

    # ===== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© =====  
    if rank >= RANKS["admin"]:  

        if command in ["Ø­Ø¸Ø±", "ÙƒØªÙ…", "ØªÙ‚ÙŠÙŠØ¯", "Ø±ÙØ¹", "ØªÙ†Ø²ÙŠÙ„", "ÙÙƒ", "Ø­Ø¸Ø±Ø¹Ø§Ù…"]:  
            target = extract_user(message, parts)
            
            if not target:  
                bot.reply_to(message, "Ø­Ø¯Ø¯ Ø§Ù„Ø´Ø®Øµ Ø¨Ø§Ù„Ø±Ø¯ Ø£Ùˆ Ø§Ù„Ø§ÙŠØ¯ÙŠ Ø£Ùˆ Ø§Ù„ÙŠÙˆØ²Ø± (ØªØ£ÙƒØ¯ Ø§Ù† Ø§Ù„ÙŠÙˆØ²Ø± ØµØ­ÙŠØ­) âŒ")  
                return  

            # Ù…Ù†Ø¹ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø±ØªØ¨ Ø£Ø¹Ù„Ù‰
            target_rank = get_rank(chat_id, target)
            if target_rank >= rank and user_id != DEVELOPER_ID:  
                bot.reply_to(message, "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø±ØªØ¨Ø© Ø£Ø¹Ù„Ù‰ Ù…Ù†Ùƒ Ø£Ùˆ Ù…Ù…Ø§Ø«Ù„Ø© âŒ")  
                return  

            # ===== Ø­Ø¸Ø± =====  
            if command == "Ø­Ø¸Ø±":  
                try:
                    bot.kick_chat_member(chat_id, target)  
                    send_action(chat_id, message, target, message.from_user.first_name, "ØªÙ… Ø­Ø¸Ø±Ù‡ ğŸš«")  
                except Exception as e:
                    bot.reply_to(message, f"Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø±Ø¨Ù…Ø§ Ù„ÙŠØ³ Ù„Ø¯ÙŠ ØµÙ„Ø§Ø­ÙŠØ©: {e}")
                return  

            # ===== ÙƒØªÙ… =====  
            if command == "ÙƒØªÙ…":  
                try:
                    bot.restrict_chat_member(chat_id, target, can_send_messages=False)  
                    send_action(chat_id, message, target, message.from_user.first_name, "ØªÙ… ÙƒØªÙ…Ù‡ ğŸ”‡")  
                except Exception as e:
                    bot.reply_to(message, f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
                return  

            # ===== ÙÙƒ ÙƒØªÙ… / ØªÙ‚ÙŠÙŠØ¯ =====  
            if command == "ÙÙƒ":
                if len(parts)>1 and parts[1] in ["ÙƒØªÙ…", "ØªÙ‚ÙŠÙŠØ¯", "Ø§Ù„Ø­Ø¸Ø±"]:  
                    try:
                        bot.restrict_chat_member(chat_id, target,  
                                                can_send_messages=True,  
                                                can_send_media_messages=True,  
                                                can_send_other_messages=True,  
                                                can_add_web_page_previews=True)  
                        send_action(chat_id, message, target, message.from_user.first_name, "ØªÙ… ÙÙƒ Ø§Ù„Ù‚ÙŠÙˆØ¯ âœ…")  
                    except Exception as e:
                        bot.reply_to(message, f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
                else:
                     bot.reply_to(message, "Ø§Ø³ØªØ®Ø¯Ù…: ÙÙƒ ÙƒØªÙ… / ÙÙƒ ØªÙ‚ÙŠÙŠØ¯")
                return  

            # ===== ØªÙ‚ÙŠÙŠØ¯ =====  
            if command == "ØªÙ‚ÙŠÙŠØ¯":  
                try:
                    bot.restrict_chat_member(chat_id, target,  
                                            can_send_messages=True,  
                                            can_send_media_messages=False,  
                                            can_send_other_messages=False,  
                                            can_add_web_page_previews=False)  
                    send_action(chat_id, message, target, message.from_user.first_name, "ØªÙ… ØªÙ‚ÙŠÙŠØ¯Ù‡ â›”")  
                except Exception as e:
                    bot.reply_to(message, f"Ø­Ø¯Ø« Ø®Ø·Ø£: {e}")
                return  

            # ===== Ø±ÙØ¹ =====  
            if command == "Ø±ÙØ¹":
                if len(parts) >= 3:  
                    role_name = parts[2] # Ù…Ø«Ø§Ù„: Ø±ÙØ¹ @user Ø§Ø¯Ù…Ù†
                else:
                    bot.reply_to(message, "Ø§Ø³ØªØ®Ø¯Ù…: Ø±ÙØ¹ [Ø§Ù„Ø±ØªØ¨Ø©] (Ø§Ø¯Ù…Ù†/Ù…Ù…ÙŠØ²/Ù†Ø§Ø¦Ø¨)")
                    return

                # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø±ØªØ¨Ø©
                role_map = {"Ø§Ø¯Ù…Ù†": "admin", "Ù…Ù…ÙŠØ²": "vip", "Ù†Ø§Ø¦Ø¨": "deputy"}
                if role_name not in role_map:
                    bot.reply_to(message, "Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©: Ø§Ø¯Ù…Ù†ØŒ Ù…Ù…ÙŠØ²ØŒ Ù†Ø§Ø¦Ø¨")
                    return
                
                new_role_key = role_map[role_name]
                new_rank = RANKS[new_role_key]  

                if new_rank >= rank and user_id != DEVELOPER_ID:  
                    bot.reply_to(message, "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø´Ø®Øµ Ù„Ù†ÙØ³ Ø±ØªØ¨ØªÙƒ Ø£Ùˆ Ø£Ø¹Ù„Ù‰ âŒ")  
                    return  

                set_rank(chat_id, target, new_rank)  
                send_action(chat_id, message, target, message.from_user.first_name, f"ØªÙ… Ø±ÙØ¹Ù‡ Ø§Ù„Ù‰ {role_name} ğŸ…")  
                return  

            # ===== ØªÙ†Ø²ÙŠÙ„ =====  
            if command == "ØªÙ†Ø²ÙŠÙ„":  
                set_rank(chat_id, target, RANKS["member"])  
                send_action(chat_id, message, target, message.from_user.first_name, "ØªÙ… ØªÙ†Ø²ÙŠÙ„Ù‡ Ø§Ù„Ù‰ Ø¹Ø¶Ùˆ ğŸ‘¤")  
                return  

            # ===== Ø­Ø¸Ø± Ø¹Ø§Ù… =====  
            if command == "Ø­Ø¸Ø±Ø¹Ø§Ù…" and user_id == DEVELOPER_ID:  
                add_global_ban(target)  
                send_action(chat_id, message, target, message.from_user.first_name, "ØªÙ… Ø­Ø¸Ø±Ù‡ Ø¹Ø§Ù… ğŸŒ")  
                return

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ§Ù„Ø¨ÙˆØª
keep_alive()
print("Bot is running...")
try:
    bot.infinity_polling(skip_pending=True)
except Exception as e:
    print(f"Error: {e}")
